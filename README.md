# Serverless-MR
> Serverless MapReduce

[![Build Status](https://travis-ci.org/hanglili/serverless-mr.svg?branch=master)](https://travis-ci.org/hanglili/serverless-mr)

Serverless-MR is a MapReduce framework that is deployed and run on a serverless platform. Currently it supports AWS 
Lambda. It can be seen as a light-weight version of Hadoop MapReduce. Hence it can be used for building cost-effective 
pipeline to run ad hoc MapReduce jobs. 

## Features
- Two modes:
    1. Serverful driver
    1. Serverless driver: Completely serverless mode where even the driver is being run in AWS Lambda.
- Allows testing of serverless MapReduce jobs locally where docker containers are used to simulate AWS Lambdas 
and other AWS services.
- Enables different input and output data sources of different types that are provided by the user.


## Quickstart::Step by Step
1. Create a python project and create the directory ```src/``` at the root-level directory of the project. 
Inside ```src/```, create a python module with any name. Inside this module, create two modules called 
```configuration``` and ```user_job```. Remember that module in python is any directory that 
contains ```__init__.py```.
2. Run the command `pip install -i https://test.pypi.org/simple/ serverless-mr==1.2.0` to install the serverless_mr library.
2. Inside the module ```configuration```, specify two configuration files: `driver.json` and `static-job-info.json`.
`driver.json` is more related to the properties of Lambda whereas `static-job-info.json` captures information related 
to the job. 
3. Inside the module ```user_job```, you can specify the map, reduce and shuffle partition functions for your job. 
    - Map function: create a file with the name of `map.py` and inside it, create a function called `map_function` that 
    is decorated with @map_handler. 
    - Reduce function: create a file with the name of `reduce.py` and inside it, create a function called `reduce_function` that 
    is decorated with @reduce_handler. 
    - Partition function for the shuffling stage: create a file with the name of `partition.py` and inside it, create a function
    called `partition`.
4. Create a main function and make it call `init_job` to start executing the job.
5. (Optional) If you want to test your job locally before it is deployed and executed on AWS, you can do so by following
this series of steps:
    1. Setting `true` to the field `localTesting` in `static-job-info.json`.
    2. Install the library `localstack` by running the command `pip install localstack`.
    3. Run docker.
    4. Download the `Dockerfile` from this project.
    5. To run localstack (which simulates AWS service behaviours with containers): 
    run `TMPDIR=/private$TMPDIR SERVICES=serverless LAMBDA_EXECUTOR=docker LAMBDA_REMOVE_CONTAINERS=false DOCKER_HOST=unix:///var/run/docker.sock  DEBUG=1 localstack start --docker`
    6. Set a value to environmental variable `serverless_mapreduce_role`.
    7. Run the main function that you have created.
6. To run the job on AWS, download the following scripts: `create-biglambda-role.py`, `delete-biglambda-role.py`, 
`setup.sh`, `policy.json`.
7. Set your AWS credentials by storing your credentials under the `credentials `file in `~/.aws/`.
8. Run command `./setup.sh <S3 job bucket> <AWS Account ID>`. Note that the S3 job bucket is used for shuffling.
It is different to the input and output data sources. 
9. Run the main function that you have created. 

## Example:
An example of using `serverless_mr` is illustrated with this project: https://github.com/hanglili/Serverless-MapReduce-Test

This example can also be served for you to understand the specific formats that the map, partition and reduce 
functions need to follow, apart form the formats of the configuration files.  

This example tries to aggregate the revenue generated by each url (output: [url, revenue]), given a list of input data of
the following format:
```
sourceIP VARCHAR(116)
destURL VARCHAR(100)
visitDate DATE
adRevenue FLOAT
userAgent VARCHAR(256)
countryCode CHAR(3)
languageCode CHAR(6)
searchWord VARCHAR(32)
duration INT
```

## Architecture

To run localstack:
```
 TMPDIR=/private$TMPDIR SERVICES=serverless LAMBDA_EXECUTOR=docker LAMBDA_REMOVE_CONTAINERS=false DOCKER_HOST=unix:///var/run/docker.sock  DEBUG=1 localstack start --docker
```

Set environment variables to:
```
serverless_mapreduce_role=arn:aws:iam::123456789:role/serverless_mr_role
```